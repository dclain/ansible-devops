suite_dns
=========

This role will manage MAS and DNS provider integration.  IBM Cloud Internet Services is the only supported DNS provider currently. It will also create a secure route (https://cp4d.<mas_domain>) to the CP4D web client using the custom domain used in this role.

## DNS management
There are two different ways this role controls DNS entries in the provider:

### Top Level DNS entries
This mode will create the entries directly under your DNS zone. Use this when the DNS zone matches the MAS domain exactly.  If your MAS installation will be using the domain **mymas.mycompany.com** and you have a DNS zone for **mymas.mycompany.com** then you will be creating top-level DNS entries for MAS, e.g. **admin**, **home**, & **api**.


### Subdomain DNS entries
This mode will create DNS entries in the zone under a subdomain. Use this when your DNS zone will be used for more than just one MAS instance.  If your MAS installation will be using the domain **mymas.mycompany.com** and you have a DNS zone for **mycompany.com** then you will be creating subdomain DNS entries for MAS, e.g. **admin.mymas**, **home.mymas**, & **api.mymas**.

CIS and Cloudflare integrations support both mode of DNS management.  A single optional variable is required to enable subdomain DNS management, in the examples above you would set these to **mymas**:

- [cis_subdomain](#cis_subdomain)
- [cloudflare_subdomain](#cloudflare_subdomain)


## Let's Encrypt Integration
Both the CIS and Cloudflare options also enable integration with [Let's Encrypt](https://letsencrypt.org/) for automatic certificate management via IBM Certificate Manager.  Each will create a new [ClusterIssuer](https://cert-manager.io/docs/reference/api-docs/#cert-manager.io/v1.ClusterIssuer) which can be used when installing Maximo Application Suite:

- Cloudflare Let's Encrypt ClusterIssuer: `{{ mas_instance_id }}-cloudflare-le-prod`
- IBM Cloud Internet Services Let's Encrypt ClusterIssuer: `{{ mas_instance_id }}-cis-le-prod`

If you want to use Let's Encrypt certificates in your MAS installation you will need to configure the `mas_cluster_issuer` variable in the [suite_install](suite_install.md) role, setting it to the name of the ClusterIssuer as documented above.

!!! note
    There are issues with how cert-manager works with LetsEncrypt staging servers. It creates a secret for the certificate that doesn't contain the LetsEncrypt CA, but the staging service does not use a well known cert so we end up with MAS unable to trust the certificates generated by LetsEncrypt staging.

    At present there is no workaround for this, so do not use the LetsEncrypt staging certificate issuer.


Role Variables - General
------------------------
### dns_provider

- **Required**
- Environment Variable: `DNS_PROVIDER`
- Default: None

### mas_instance_id:

- **Required**
- Environment Variable: `MAS_INSTANCE_ID`
- Default: None

### mas_domain

- **Required**
- Environment Variable: `MAS_DOMAIN`
- Default: None

### ocp_ingress

- Optional
- Environment Variable: `OCP_INGRESS`
- Default: None

Role Variables - Cloudflare DNS Integration
-------------------------------------------
### cloudflare_email

- **Required** if `dns_provider` is set to `cloudflare`
- Environment Variable: `CLOUDFLARE_EMAIL`
- Default: None

### cloudflare_apitoken
To generate an API token follow the [Cloudflare documentation](https://developers.cloudflare.com/api/tokens/create/).

- **Required** if `dns_provider` is set to `cloudflare`
- Environment Variable: `CLOUDFLARE_APITOKEN`
- Default: None

### cloudflare_zone
This is your domain name that is managed by Cloudflare (e.g. `mydomain.com`).

- **Required** if `dns_provider` is set to `cloudflare`
- Environment Variable: `CLOUDFLARE_ZONE`
- Default: None

### cloudflare_subdomain
Set this to the name of the subdomain under your Cloudflare domain where you would like to manage the MAS DNS entires if you don't want MAS to use the top-level domain itself.  In other words `cloudflare_subdomain.cloudflare_zone` should equal `mas_domain`.

- Optional
- Environment Variable: `CLOUDFLARE_SUBDOMAIN`
- Default: None

Role Variables - IBM Cloud Internet Services DNS Integration
------------------------------------------------------------
### cis_email

- **Required** if `dns_provider` is set to `cis`
- Environment Variable: `CIS_EMAIL`
- Default: None

### cis_apikey

- **Required** if `dns_provider` is set to `cis`
- Environment Variable: `CIS_APIKEY`
- Default: None

### cis_crn

- **Required** if `dns_provider` is set to `cis`
- Environment Variable: `CIS_CRN`
- Default: None

### cis_subdomain

- Optional
- Environment Variable: `CIS_SUBDOMAIN`
- Default: None


Example Playbook
----------------

```yaml
---
- hosts: localhost
  any_errors_fatal: true
  vars:
    mas_instance_id: inst1
    mas_domain: mydomain.com
    cis_crn: xxx
    cis_apikey: xxx
    cis_email: xxx
  roles:
    - ibm.mas_devops.suite_dns
```

License
-------

EPL-2.0
